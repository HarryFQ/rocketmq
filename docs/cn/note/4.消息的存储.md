## [消息的存储](https://www.cnblogs.com/shanml/p/16428961.html)
### 1. 消息处理
#### 1.1 Broker启动时注册消息处理器SendMessageProcessor处理生产者发送的消息
1. 单个消息处理
2. 批量消息处理
### 2. 消息持久化
1. 合法性校验
   1. broker是否可以进行消息写入
   2. 消息长度校验，是否超过最大值
   3. 在开启LMQ时是否超过最大消费数量
2. 消息写入
   1. 对消息进行编码，并将消息相关信息及内容写入到内存buffer
   2. 获取CommitLog 对应映射文件的MappedFile 
      1. 记录了文件大小，写入位置
      2. 每个CommitLog大小限定1G
      3. 开辟共享内存缓冲区bytebuffer
   3. 通过回调函数将消息写入映射文件
      1. 计算要写入文件位置的偏移量
      2. 校验是否有足够的空间写入数据
      3. 将消息的内容写入文件共享缓冲区bytebuffer, 此时消息内容已经驻留在操作系统的pageCache中等待刷盘
   4. 执行属盘策略
      1. 同步刷盘
      2. 异步刷盘